<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanFree Pro | HMRC Receipt Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
    <style>
        :root { --uk-blue: #002366; --uk-red: #C8102E; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; }
        header { background: var(--uk-blue); color: white; width: 100%; padding: 1.5rem; text-align: center; border-bottom: 4px solid var(--uk-red); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .container { max-width: 480px; width: 92%; background: white; margin: 20px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .btn-scan { background: var(--uk-blue); color: white; border: none; padding: 18px; border-radius: 10px; font-size: 1.1rem; font-weight: bold; width: 100%; cursor: pointer; display: block; text-align: center; margin-bottom: 15px; }
        .ad-box { background: #f1f1f1; border: 1px dashed #ccc; height: 90px; margin: 15px 0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #777; overflow: hidden; }
        .status-bar { padding: 10px; text-align: center; font-size: 0.9rem; color: #555; background: #eef2f7; border-radius: 5px; margin-bottom: 15px; display: none; }
        .field-group { margin-bottom: 12px; }
        label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 5px; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1.5px solid #ddd; border-radius: 8px; font-size: 1rem; box-sizing: border-box; }
        #preview { width: 100%; border-radius: 10px; margin-bottom: 15px; display: none; }
    </style>
</head>
<body>

<header>
    <h1>ScanFree Pro</h1>
    <p>Free UK Tax Record Assistant</p>
</header>

<div class="ad-box" id="ad-top">
    [AD SPACE - SOCIAL BAR]
</div>

<div class="container">
    <img id="preview" src="#" alt="Receipt Preview">
    
    <label class="btn-scan">
        üì∑ TAKE PHOTO / UPLOAD
        <input type="file" id="upload" accept="image/*" capture="environment" style="display:none;">
    </label>

    <div id="status" class="status-bar"></div>

    <div class="field-group">
        <label>Transaction Date</label>
        <input type="text" id="date" placeholder="DD/MM/YYYY">
    </div>

    <div class="field-group">
        <label>Total Amount (¬£)</label>
        <input type="text" id="amount" placeholder="0.00">
    </div>

    <div class="field-group">
        <label>Expense Category (HMRC)</label>
        <select id="category">
            <option>Car, Van & Travel</option>
            <option>Rent, Rates & Power</option>
            <option>Phone & Internet</option>
            <option>Advertising/Marketing</option>
            <option>Office Stationery</option>
            <option>Other Business Costs</option>
        </select>
    </div>

    <button onclick="saveRecord()" class="btn-scan" style="background:#28a745; margin-top:10px;">üíæ DOWNLOAD CSV RECORD</button>
</div>

<div class="ad-box" id="ad-bottom">
    [AD SPACE - NATIVE BANNER]
</div>

<script>
    const upload = document.getElementById('upload');
    const status = document.getElementById('status');
    const preview = document.getElementById('preview');

    upload.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Visual Feedback
        preview.src = URL.createObjectURL(file);
        preview.style.display = 'block';
        status.style.display = 'block';
        status.innerText = "Connecting to OCR Engine... üîå";

        try {
            // New v5 syntax for best performance
            const worker = await Tesseract.createWorker('eng');
            status.innerText = "Analyzing Receipt Text... üìù";
            
            const { data: { text } } = await worker.recognize(file);
            console.log("Extracted Data:", text);

            // 1. IMPROVED AMOUNT FINDER (Look for ¬£ or TOTAL)
            const priceRegex = /(?:¬£|GBP|TOTAL|SUM|DUE|AMT)\s*([\d,]+\.\d{2})/i;
            const matchPrice = text.match(priceRegex);
            if (matchPrice) document.getElementById('amount').value = matchPrice[1].replace(',', '');

            // 2. IMPROVED DATE FINDER (UK Format)
            const dateRegex = /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/;
            const matchDate = text.match(dateRegex);
            if (matchDate) document.getElementById('date').value = matchDate[0];

            status.innerText = "Done! Review details below. ‚úÖ";
            await worker.terminate();
        } catch (err) {
            console.error(err);
            status.innerText = "Error: Please use a clearer photo. ‚ùå";
        }
    });

    function saveRecord() {
        const d = document.getElementById('date').value;
        const a = document.getElementById('amount').value;
        const c = document.getElementById('category').value;
        if(!d || !a) { alert("Please ensure Date and Amount are filled."); return; }

        const csvData = "Date,Amount,Category\n" + `${d},${a},${c}`;
        const blob = new Blob([csvData], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a_tag = document.createElement('a');
        a_tag.setAttribute('href', url);
        a_tag.setAttribute('download', `UK-Tax-Record-${d}.csv`);
        a_tag.click();
    }
</script>

</body>
</html>
