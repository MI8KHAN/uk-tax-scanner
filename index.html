<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScanFree Pro | UK Tax Receipt Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.1.1/dist/tesseract.min.js"></script>
    <style>
        :root { --uk-blue: #002366; --uk-red: #C8102E; --bg: #f0f2f5; }
        body { font-family: 'Segoe UI', Helvetica, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; align-items: center; color: #333; }
        header { background: var(--uk-blue); color: white; width: 100%; padding: 20px 0; text-align: center; border-bottom: 4px solid var(--uk-red); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .container { max-width: 450px; width: 90%; background: white; margin: 20px; padding: 25px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .btn-main { background: var(--uk-blue); color: white; border: none; padding: 16px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; width: 100%; cursor: pointer; transition: 0.3s; margin-bottom: 15px; display: block; text-align: center; }
        .btn-main:active { transform: scale(0.98); }
        .ad-space { background: #fafafa; border: 1px dashed #bbb; height: 90px; margin: 15px 0; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #999; overflow: hidden; }
        .status-box { padding: 12px; text-align: center; font-size: 0.9rem; background: #e7f3ff; color: #0056b3; border-radius: 8px; margin-bottom: 20px; display: none; border: 1px solid #d0e7ff; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 6px; color: #555; }
        input, select { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: var(--uk-blue); outline: none; }
        #receipt-preview { width: 100%; border-radius: 10px; margin-bottom: 15px; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        footer { font-size: 12px; color: #888; margin-top: 10px; text-align: center; padding-bottom: 20px; }
    </style>
</head>
<body>

<header>
    <h1 style="margin:0; font-size: 1.8rem;">ScanFree Pro</h1>
    <p style="margin:5px 0 0; opacity: 0.9;">HMRC-Ready Expense Logging</p>
</header>

<div class="ad-space" id="ad-top"> [ADSTERRA SOCIAL BAR SPACE] </div>

<div class="container">
    <img id="receipt-preview" src="#" alt="Preview">
    
    <label class="btn-main">
        ðŸ“¸ CAPTURE RECEIPT
        <input type="file" id="image-upload" accept="image/*" capture="environment" style="display:none;">
    </label>

    <div id="status-msg" class="status-box"></div>

    <div class="input-group">
        <label>Transaction Date</label>
        <input type="text" id="res-date" placeholder="DD/MM/YYYY">
    </div>

    <div class="input-group">
        <label>Total Amount (Â£)</label>
        <input type="text" id="res-amount" placeholder="0.00">
    </div>

    <div class="input-group">
        <label>HMRC Expense Category</label>
        <select id="res-category">
            <option>Travel (Fuel/Train/Taxi)</option>
            <option>Office Costs (Stationery/Phone)</option>
            <option>Staff Costs (Salaries/Subcontractors)</option>
            <option>Advertising & Marketing</option>
            <option>Financial Costs (Insurance/Bank)</option>
            <option>Other Business Expenses</option>
        </select>
    </div>

    <button onclick="downloadCSV()" class="btn-main" style="background:#28a745; margin-top:10px;">ðŸ’¾ DOWNLOAD CSV</button>
</div>

<div class="ad-space" id="ad-bottom"> [ADSTERRA NATIVE BANNER] </div>

<footer>
    &copy; 2026 UK Tax Record Assistant<br>
    Built for Sole Traders & Small Businesses
</footer>

<script>
    const uploadInput = document.getElementById('image-upload');
    const statusMsg = document.getElementById('status-msg');
    const previewImg = document.getElementById('receipt-preview');

    uploadInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // Show UI feedback
        previewImg.src = URL.createObjectURL(file);
        previewImg.style.display = 'block';
        statusMsg.style.display = 'block';
        statusMsg.innerText = "Starting OCR Engine... âš¡";

        try {
            const worker = await Tesseract.createWorker('eng');
            statusMsg.innerText = "Reading Receipt Details... ðŸ”";
            
            const { data: { text } } = await worker.recognize(file);
            console.log("Extracted Text:", text); // Debugging info

            // 1. IMPROVED AMOUNT FINDER
            // Finds numbers after Â£, TOTAL, AMT, or just the largest decimal number
            const amountRegex = /(?:Â£|TOTAL|GBP|AMT|DUE)\s*([\d,]+\.\d{2})/i;
            const foundAmount = text.match(amountRegex);
            if (foundAmount) {
                document.getElementById('res-amount').value = foundAmount[1].replace(',', '');
            } else {
                // Fallback: Find the last decimal number in the text (often the total)
                const allAmounts = text.match(/\d+\.\d{2}/g);
                if (allAmounts) document.getElementById('res-amount').value = allAmounts[allAmounts.length - 1];
            }

            // 2. IMPROVED DATE FINDER
            const dateRegex = /(\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{2,4})/;
            const foundDate = text.match(dateRegex);
            if (foundDate) document.getElementById('res-date').value = foundDate[0];

            statusMsg.innerText = "Scan Successful! âœ…";
            statusMsg.style.background = "#d4edda";
            statusMsg.style.color = "#155724";
            
            await worker.terminate();
        } catch (err) {
            console.error("Scan Error:", err);
            statusMsg.innerText = "Scan failed. Please use a clearer photo. âŒ";
            statusMsg.style.background = "#f8d7da";
            statusMsg.style.color = "#721c24";
        }
    });

    function downloadCSV() {
        const date = document.getElementById('res-date').value || "Unknown";
        const amount = document.getElementById('res-amount').value || "0.00";
        const category = document.getElementById('res-category').value;

        // Create CSV with BOM for Excel Support
        const csvContent = "\uFEFFDate,Amount,Category\n" + `"${date}","${amount}","${category}"`;
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", `UK-Receipt-${date.replace(/[\/\.]/g, '-')}.csv`);
        link.style.visibility = 'hidden';
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        setTimeout(() => URL.revokeObjectURL(url), 100);
    }
</script>

</body>
</html>
