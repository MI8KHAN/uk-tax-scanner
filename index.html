<!DOCTYPE html>
<html lang="en-GB">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Free UK Receipt Scanner for HMRC MTD 2026. Private, Offline, and Free.">
    <title>ScanFree Pro | UK Tax Receipt Scanner</title>
    
    <script src="https://unpkg.com/tesseract.js@v4.0.1/dist/tesseract.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .scanner-overlay {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(to bottom, transparent 45%, rgba(59, 130, 246, 0.5) 50%, transparent 55%);
            background-size: 100% 200%;
            animation: scan 2s linear infinite;
            pointer-events: none;
        }
        @keyframes scan { 0% { background-position: 0% -100%; } 100% { background-position: 0% 200%; } }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <header class="p-4 border-b border-gray-800 bg-slate-900/80 sticky top-0 z-50 backdrop-blur-md">
        <div class="max-w-md mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-white">ScanFree <span class="text-blue-500">UK</span></h1>
                <p class="text-xs text-gray-400">HMRC MTD Ready ‚Ä¢ Offline Mode</p>
            </div>
            <button class="text-gray-400 hover:text-white transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </button>
        </div>
    </header>

    <main class="flex-grow p-4 max-w-md mx-auto w-full space-y-6">

        <div id="ad-slot-top" class="w-full h-16 bg-slate-800/50 rounded-lg flex items-center justify-center text-xs text-gray-600 border border-dashed border-gray-700">
            [Ad Space - Auto-Updates]
        </div>

        <section id="upload-section" class="relative">
            <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden">
            
            <button onclick="triggerCamera()" class="w-full aspect-video rounded-2xl border-2 border-dashed border-blue-500/50 bg-slate-800/50 flex flex-col items-center justify-center hover:bg-slate-800 transition-all group relative overflow-hidden">
                <div class="absolute inset-0 bg-blue-500/5 group-hover:bg-blue-500/10 transition-colors"></div>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                <span class="font-semibold text-blue-400">Tap to Scan Receipt</span>
                <span class="text-xs text-gray-500 mt-1">Supports JPG, PNG ‚Ä¢ 100% Private</span>
            </button>
        </section>

        <section id="processing-state" class="hidden text-center py-8">
            <div class="relative w-16 h-16 mx-auto mb-4">
                <div class="absolute inset-0 rounded-full border-4 border-slate-700"></div>
                <div class="absolute inset-0 rounded-full border-4 border-blue-500 border-t-transparent animate-spin"></div>
            </div>
            <h3 class="text-lg font-medium text-white">Analyzing Receipt...</h3>
            <p id="progress-text" class="text-sm text-gray-400 mt-2">Initializing OCR Engine...</p>
        </section>

        <section id="result-form" class="hidden space-y-4">
            <div class="glass-panel p-5 rounded-xl">
                <h2 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-4">Transaction Details</h2>
                
                <div class="mb-4">
                    <label class="block text-xs text-blue-400 mb-1">Date</label>
                    <input type="date" id="date-field" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors">
                </div>

                <div class="mb-4">
                    <label class="block text-xs text-blue-400 mb-1">Total Amount (¬£)</label>
                    <input type="number" step="0.01" id="amount-field" placeholder="0.00" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors text-lg font-mono">
                </div>

                <div class="mb-6">
                    <label class="block text-xs text-blue-400 mb-1">HMRC Expense Category</label>
                    <select id="category-field" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition-colors appearance-none">
                        <option value="" disabled selected>Select Category...</option>
                        <option value="office">Office Costs (Stationery, Phone)</option>
                        <option value="travel">Travel (Fuel, Parking, Train)</option>
                        <option value="clothing">Uniforms & Protective Clothing</option>
                        <option value="staff">Staff Costs (Salaries, Subcontractors)</option>
                        <option value="stock">Reselling Goods / Materials</option>
                        <option value="finance">Financial Costs (Bank Charges, Insurance)</option>
                        <option value="premises">Business Premises (Rent, Power)</option>
                        <option value="advertising">Advertising & Marketing</option>
                        <option value="training">Training Courses</option>
                    </select>
                </div>

                <button onclick="exportToCSV()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition-all shadow-lg shadow-green-900/20 flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    Save to Digital Record (CSV)
                </button>
                
                <button onclick="resetApp()" class="w-full mt-3 py-3 text-sm text-gray-500 hover:text-white transition">Scan Another Receipt</button>
            </div>
        </section>

        <section class="mt-8 pt-6 border-t border-gray-800">
            <h3 class="text-sm font-semibold text-center text-gray-300 mb-3">Recommended for Sole Traders</h3>
            <a href="#" target="_blank" class="block w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text-white font-bold py-4 rounded-xl text-center shadow-lg transition-all relative overflow-hidden">
                <span class="relative z-10">üè¶ Open Business Bank Account</span>
                <div class="absolute inset-0 bg-white/10 opacity-0 hover:opacity-100 transition-opacity"></div>
            </a>
            <p class="text-center text-[10px] text-gray-500 mt-2">Ad ‚Ä¢ Terms Apply</p>
        </section>

    </main>

    <footer class="p-6 text-center text-xs text-gray-600 space-y-2 pb-8">
        <p>Your data is processed locally. No images are uploaded to any server.</p>
        <p>¬© 2026 ScanFree UK. Not affiliated with HMRC.</p>
    </footer>

    <script>
        // DOM Elements
        const imageInput = document.getElementById('imageInput');
        const uploadSection = document.getElementById('upload-section');
        const processingState = document.getElementById('processing-state');
        const resultForm = document.getElementById('result-form');
        const progressText = document.getElementById('progress-text');

        // Trigger File Input
        function triggerCamera() {
            imageInput.click();
        }

        // Handle Image Selection
        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // UI Transition
            uploadSection.classList.add('hidden');
            processingState.classList.remove('hidden');
            
            try {
                // Initialize Tesseract Worker
                const worker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            progressText.innerText = `Scanning... ${Math.round(m.progress * 100)}%`;
                        } else {
                            progressText.innerText = m.status;
                        }
                    }
                });

                // Perform OCR
                const { data: { text } } = await worker.recognize(file);
                await worker.terminate();

                // Smart Parsing Logic (UK Specific)
                parseReceiptData(text);

                // Show Results
                processingState.classList.add('hidden');
                resultForm.classList.remove('hidden');

            } catch (error) {
                alert("Error scanning receipt. Please try again.");
                resetApp();
            }
        });

        // Regex Logic to find Dates and Prices
        function parseReceiptData(text) {
            console.log("Raw OCR Text:", text); // For debugging
            
            // 1. Find Price (Looks for ¬£ or decimals like 10.99)
            const priceRegex = /¬£?\s?(\d+\.\d{2})\b/g;
            const prices = [...text.matchAll(priceRegex)].map(m => parseFloat(m[1]));
            if (prices.length > 0) {
                // Usually the highest number on a receipt is the total
                const maxPrice = Math.max(...prices);
                document.getElementById('amount-field').value = maxPrice.toFixed(2);
            }

            // 2. Find Date (DD/MM/YYYY or DD-MM-YYYY)
            const dateRegex = /\b(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})\b/;
            const dateMatch = text.match(dateRegex);
            if (dateMatch) {
                // Format to YYYY-MM-DD for input field
                let [_, day, month, year] = dateMatch;
                if (year.length === 2) year = "20" + year;
                const formattedDate = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                document.getElementById('date-field').value = formattedDate;
            } else {
                // Default to today if no date found
                document.getElementById('date-field').valueAsDate = new Date();
            }
        }

        // Export Function (HMRC Compliant CSV)
        function exportToCSV() {
            const date = document.getElementById('date-field').value;
            const amount = document.getElementById('amount-field').value;
            const category = document.getElementById('category-field').value;

            if (!amount || !category) {
                alert("Please ensure Amount and Category are filled.");
                return;
            }

            // CSV Format: Date, Amount, Category, Currency
            const csvContent = `Date,Amount,Category,Currency\n${date},${amount},${category},GBP`;
            
            // Create Download Link
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", `receipt_${date}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Reset App State
        function resetApp() {
            imageInput.value = "";
            resultForm.classList.add('hidden');
            uploadSection.classList.remove('hidden');
            progressText.innerText = "Initializing...";
            document.getElementById('amount-field').value = "";
            document.getElementById('category-field').selectedIndex = 0;
        }
    </script>
</body>
</html>
